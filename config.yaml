# 基础配置
work_dir: "./tmp"
output_dir: "./out"

# Mihomo 配置
mihomo:
  api_url: "https://api.github.com/repos/MetaCubeX/mihomo/releases"
  start_with: "mihomo-linux-amd64-alpha"
  end_with: ".gz"

# Git 配置
git:
  user_email: "259484229+oom-wg[bot]@users.noreply.github.com"
  user_name: "oom-wg[bot]"
  release_branch: "release"
  max_history: 7
  timezone: "Asia/Shanghai"

# 任务配置
tasks:
  ad:
    format: "mrs"
    src: 
      - "https://github.com/privacy-protection-tools/anti-AD/raw/refs/heads/master/anti-ad-clash.yaml"
      - "https://github.com/Cats-Team/AdRules/raw/refs/heads/main/adrules_domainset.txt"
      - "https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geosite/category-httpdns-cn@ads.list"
      - "https://github.com/ignaciocastro/a-dove-is-dumb/raw/refs/heads/main/pihole.txt"
    custom_script: |
      print(f"  -> 执行自定义 AD 清洗，处理前数量: {len(domains)}")

      rules_map = {
          ".xx.fbcdn.net.iberostar.com": "+.xx.fbcdn.net.iberostar.com",
          ".wns.windows.com":            "+.wns.windows.com",
          ".p2l.info":                   "+.p2l.info",
          ".wo.com.cn":                  None,
          ".apps.iocnt.de":              "+.apps.iocnt.de"
      }
      
      # 将字典的 keys 转换为元组，供 endswith 底层 C 加速匹配
      check_suffixes = tuple(rules_map.keys())
      new_domains = []

      for d in domains:
          # 1. 特殊正则逻辑
          if d.startswith("+.data-") and d.endswith(".apps.iocnt.de"):
              continue
          
          # 2. 批量后缀匹配 (由于传入的是元组，只需 O(1) 级别的底层调用)
          if d.endswith(check_suffixes):
              continue
              
          # 3. 未被拦截的域名保留
          new_domains.append(d)

      # 4. 统一补回泛域名规则
      for replacement in rules_map.values():
          if replacement:
              new_domains.append(replacement)

      domains = new_domains
      print(f"  -> 清洗完成，处理后数量: {len(domains)}")

  SteamCN:
    format: "mrs"
    src:
      - "https://raw.githubusercontent.com/Jarv1s0/Logic/refs/heads/master/Clash/rules/SteamCN.yaml"
      - "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Game/GameDownloadCN/GameDownloadCN.list"
    custom_script: |
      print(f"  -> 执行 SteamCN 规则检查，处理前数量: {len(domains)}")
      
      # 移除不属于 Steam 体系的微软相关/脏规则残留（如果源中有的话）
      # 这里使用单次遍历清理，不增加额外内存开销
      dirty_keywords = ("dsp.mp.microsoft.com", ".wns.windows.com", ".100.in-addr.arpa", ".download.prss.microsoft.com")
      
      domains = [d for d in domains if not d.endswith(dirty_keywords) and "dsp.mp.microsoft.com" not in d]
      
      # 补充你认为 SteamCN 必须有的遗漏规则 (按需填写)
      # domains.append("+.steamcontent.com")

      print(f"  -> 清理完成，处理后数量: {len(domains)}")

  cnIP:
    format: "mrs"
    src:
      - "https://github.com/MetaCubeX/meta-rules-dat/raw/meta/geo/geoip/cn.list"
      - "https://github.com/MetaCubeX/meta-rules-dat/raw/meta/geo/geoip/private.list"
